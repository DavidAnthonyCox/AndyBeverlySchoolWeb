(function(){"use strict";TS.registerModule("storage",{msgs_version:function(){try{return window.boot_data.cache_version}catch(err){return"unknown_version"}}(),version:"0.82",prefix:window.boot_data.user_id+"_",disabled:false,buffer:{},disable_interval_buffer_write:function(){var ua,offset,version,ssb_str,min_version,supported;supported=true;ssb_str="slack_ssb/";min_version=.45;ua=navigator.userAgent.toLowerCase();offset=ua.indexOf(ssb_str);if(offset!==-1){version=parseFloat(ua.substr(offset+ssb_str.length));if(!isNaN(version)&&version<min_version){supported=false}}return supported}(),flush_buffer_interv:0,flush_buffer_interv_ms:1e3,test:function(){return{getLocalStorage:_getLs,setLocalStorage:_setLs}},setDisabled:function(disabled){if(TS.storage.disabled==disabled)return;if(disabled||!_ls){TS.storage.disabled=true}else{TS.storage.disabled=false;TS.storage.setUp()}TS.info("TS.storage.disabled:"+TS.storage.disabled)},onStart:function(){TS.storage.onStart=function(){};var should_disable=TS.storage.disabled||TS.qs_args["ls_disabled"]=="1"||!_ls||function(){if(TS.storage.storageAvailable())return false;TS.warn("TS.storage.storageAvailable() = false in onStart so flushing");_ls.clear();if(TS.storage.storageAvailable()){try{if(TS.boot_data.login_data.self.prefs.ls_disabled){return true}}catch(err){}return false}TS.warn("TS.storage.storageAvailable() = false in onStart after after flushing, so disabling");return true}();TS.log(488,"TS.storage.onStart should_disable:"+should_disable);TS.storage.setDisabled(should_disable);TS.ui.window_unloaded_sig.add(TS.storage.windowUnloaded);TS.ui.window_focus_changed_sig.add(TS.storage.windowBlurred);if(!TS.storage.disabled)TS.storage.setUp()},getKeys:function(){var A=[];if(!_ls)return A;var len=_ls.length;if(!len)return A;for(var i=0;i<len;i++){A.push(_ls.key(i))}return A},storageAvailable:function(){if(!_ls)return false;try{var key="test_to_see_if_we_can_write_to_local_storage";_ls.setItem(key,"foo");_ls.removeItem(key);return true}catch(err){return false}},storageSize:function(log){var length=0;if(!_ls)return length;var keys=TS.storage.getKeys();var c=0;var key;var value;for(var i=0;i<keys.length;i++){c++;key=keys[i];value=_ls.getItem(key);if(!value&&value!==""){TS.warn(key+" not measurable value:"+value+" typeof:"+typeof value)}else{length+=value.length;if(log)TS.info(key+"="+(value.length*2/1024).toFixed(2)+"KB "+"(total="+(length/1024).toFixed(2)+"KB)")}}if(log)TS.info("total for "+c+" items is "+(length/1024).toFixed(2)+"KB");return length},setUp:function(){var storage_msgs_version=TS.storage.fetchMsgsStorageVersion();TS.log(488,"TS.storage.msgs_version:"+TS.storage.msgs_version);TS.log(488,"storage_msgs_version:"+storage_msgs_version);var storage_version=TS.storage.fetchStorageVersion();TS.log(488,"TS.storage.version:"+TS.storage.version);TS.log(488,"storage_version:"+storage_version);TS.log(488,"TS.storage.storageAvailable(): "+TS.storage.storageAvailable());var keys=TS.storage.getKeys();TS.log(488,keys);var key;if(!TS.storage.storageAvailable()){TS.warn("TS.storage.storageAvailable() = false so flushing");_ls.clear()}else if(storage_version!=TS.storage.version||!TS.storage.fetchLastEventTS()&&TS.client){if(storage_version!=TS.storage.version){TS.warn("storage_version:"+storage_version+" does not match TS.storage.version:"+TS.storage.version+" so flushing")}else if(storage_version){TS.warn("TS.storage.fetchLastEventTS() is empty so flushing");TS.logError({message:"TS.storage.fetchLastEventTS() is empty #2 B"},"TS.storage.fetchLastEventTS() is empty but we have a storage_version, so flushing LS from TS.storage")}for(var i=0;i<keys.length;i++){key=keys[i];if(key.indexOf(TS.storage.prefix)!==0)continue;var start=Date.now();_ls.removeItem(key);TS.warn("_ls.removeItem:"+key+" "+(Date.now()-start)+"ms")}TS.storage.storeStorageVersion(TS.storage.version);TS.storage.storeMsgsStorageVersion(TS.storage.msgs_version);if(TS.storage.getKeys().length>0)TS.info(TS.storage.getKeys())}else if(storage_msgs_version!=TS.storage.msgs_version||TS.qs_args["no_ls_msgs"]=="1"){if(TS.qs_args["no_ls_msgs"]=="1"){TS.warn("TS.qs_args['no_ls_msgs'] == '1' so flushing channel data")}else{TS.warn("storage_msgs_version:"+storage_msgs_version+" does not match TS.storage.msgs_version:"+TS.storage.msgs_version+" so flushing channel data")}TS.storage.cleanOutMsgStorage();TS.storage.storeMsgsStorageVersion(TS.storage.msgs_version);if(TS.storage.getKeys().length>0)TS.warn(TS.storage.getKeys())}if(TS.storage.disable_interval_buffer_write){TS.storage.flushBufferOnIdleTimer()}},cleanOutMsgStorageAndResetIfTooOld:function(){if(TS.storage.isStorageTooOld()){TS.warn("last LS activity too old, we're purging");TS.storage.cleanOutMsgStorageAndReset();return true}return false},cleanOutMsgStorageAndReset:function(){TS.info("cleanOutMsgStorageAndReset running");TS.storage.cleanOutMsgStorage();TS.storage.storeLastEventTS("",true,true);TS.storage.storeLastMsgTS("",true);TS.storage.storeRxnRecords("",true);var fetched_b4_flush=TS.storage.fetchLastEventTS(true);TS.info("cleanOutMsgStorageAndReset fetched_b4_flush:"+fetched_b4_flush);if(fetched_b4_flush){TS.info("TS.storage.getKeys:"+TS.storage.getKeys().join(", "));TS.info("Object.keys(TS.storage.buffer):"+Object.keys(TS.storage.buffer).join(", "))}TS.storage.flushBuffer(true);var fetched_after_flush=TS.storage.fetchLastEventTS(true);TS.info("cleanOutMsgStorageAndReset fetched_after_flush:"+fetched_after_flush);if(fetched_after_flush){TS.info("TS.storage.getKeys:"+TS.storage.getKeys().join(", "));TS.info("Object.keys(TS.storage.buffer):"+Object.keys(TS.storage.buffer).join(", "))}},isStorageTooOld:function(){var last_event_ts=TS.storage.fetchLastEventTS();var last_msg_ts=TS.storage.fetchLastMsgTS();var last_ts=last_event_ts;if(!last_ts||last_msg_ts>last_event_ts)last_ts=last_msg_ts;if(last_ts){var last_date=TS.utility.date.toDateObject(last_ts);var elapsed=Date.now()-last_date;var limit_ms=3*864e5;if(elapsed>limit_ms){return true}}return false},cleanOutMsgStorage:function(){var keys=TS.storage.getKeys();TS.log(488,keys);var key;for(var i=0;i<keys.length;i++){key=keys[i];if(key.indexOf(TS.storage.prefix)!==0)continue;if(key.indexOf(TS.storage.msgs_id_part)==-1&&key.indexOf(TS.storage.oldest_ts_part)==-1)continue;var start=Date.now();_ls.removeItem(key);delete TS.storage.buffer[key];TS.warn("_ls.removeItem:"+key+" "+(Date.now()-start)+"ms")}for(key in TS.storage.buffer){if(key.indexOf(TS.storage.prefix)!==0)continue;if(key.indexOf(TS.storage.msgs_id_part)==-1&&key.indexOf(TS.storage.oldest_ts_part)==-1)continue;delete TS.storage.buffer[key];TS.info("delete TS.storage.buffer:"+key)}keys=TS.storage.getKeys();TS.log(488,keys)},windowUnloaded:function(){TS.storage._set("last_unload_flushing",(new Date).toString(),true);TS.storage.flushBuffer(true)},windowBlurred:function(){TS.storage.flushBuffer(true)},onFlushBufferInterval:function(){TS.storage.flushBuffer(false)},slow_write:false,slow_all_write:false,slow_write_threshold:1e3,flush_all_buffer_interv:null,flush_all_buffer_interv_ms:2e3,flush_all_buffer_user_inactive_ms:3e3,flushBufferOnIdleTimer:function(){if(TS.storage.flush_all_buffer_interv){window.clearInterval(TS.storage.flush_all_buffer_interv);TS.storage.flush_all_buffer_interv=null}TS.storage.flush_all_buffer_interv=window.setInterval(TS.storage.maybeFlushAllBuffer,TS.storage.flush_all_buffer_interv_ms)},maybeFlushAllBuffer:function(){if(!TS.model)return;var ok_to_flush=false;if(!TS.model.ui.is_window_focused){ok_to_flush=true}else{var now=new Date;var ms_since_activity=now-TS.model.client.last_user_active_timestamp;if(ms_since_activity>=TS.storage.flush_all_buffer_user_inactive_ms){ok_to_flush=true}}TS.log(488,"TS.storage.maybeFlushAllBuffer ok_to_flush:"+ok_to_flush);if(ok_to_flush){TS.storage.flushBuffer(true)}},prepareValForStorage:function(val){return typeof val=="string"||typeof val=="number"||!val?val:JSON.stringify(val)},correctBadValsFromStorage:function(val){if(val=="undefined")return null;if(val=="null")return null;return val},flushBuffer:function(all){if(TS.storage.disabled)return;var begin=new Date;var start=Date.now();var duration;var i=0;var do_log=TS.model&&TS.model.team&&TS.model.team.domain&&TS.model.team.domain==="tinyspeck";var elapsed;var storage_size;var debug_time;if(!all&&TS.storage.disable_interval_buffer_write){return false}var val;for(var k in TS.storage.buffer){val=TS.storage.prepareValForStorage(TS.storage.buffer[k]);if(val===undefined){_ls.removeItem(k)}else{try{_ls.setItem(k,val)}catch(err){TS.warn("flushBuffer _ls.setItem failed once, flushing. TS.storage.storageSize():"+TS.storage.storageSize(false));TS.dir(0,err);_ls.clear();try{_ls.setItem(k,val)}catch(err_again){TS.warn("flushBuffer _ls.setItem failed twice, flushing and bailing. TS.storage.storageSize():"+TS.storage.storageSize());TS.dir(0,err_again);_ls.clear();continue}}}i++;duration=Date.now()-start;TS.storage.flush_buffer_interv_ms=TS.utility.clamp(duration*3,1e3,5e3);if(do_log){TS.log(488,"onFlushBufferInterval _ls.setItem "+k+": "+duration+"ms "+(TS.storage.buffer[k]&&TS.storage.buffer[k].toString?TS.storage.buffer[k].toString().substr(0,100):"NULL?"))}if(!all){elapsed=new Date-begin;if(!TS.storage.slow_write&&elapsed>TS.storage.slow_write_threshold){TS.storage.slow_write=true;debug_time=new Date;try{storage_size=TS.storage.storageSize()}catch(err){}debug_time=new Date-debug_time;TS.logError({message:"Took "+elapsed+"ms for "+i+" item (!all case) (threshold is "+TS.storage.slow_write_threshold+" ms). Key: "+k+". Buffer length: "+(TS.storage.buffer[k]&&TS.storage.buffer[k].toString()?TS.storage.buffer[k].toString().length:"unknown (not a string)")+". localStorage size: "+(storage_size||"unknown")+". Time to read LS size: "+debug_time},"TS.storage.flushBuffer exceeded slow write threshold")}}delete TS.storage.buffer[k];if(!all){TS.log(488,"TS.storage.flushBuffer: Wrote one item.");return}}if(i&&!TS.storage.slow_all_write){elapsed=new Date-begin;if(elapsed>TS.storage.slow_write_threshold){TS.storage.slow_all_write=true;try{storage_size=TS.storage.storageSize()}catch(err){}TS.logError({message:"Took "+elapsed+"ms for "+i+" items (threshold is "+TS.storage.slow_write_threshold+" ms). localStorage size: "+storage_size+". App open for "+((new Date-TS.view.start_time)/1e3/60).toFixed(2)+" min."},"TS.storage.flushBuffer exceeded slow write threshold (all case)")}}if(i===0){if(TS.storage.flush_buffer_interv){window.clearInterval(TS.storage.flush_buffer_interv);TS.storage.flush_buffer_interv=null}TS.log(488,"TS.storage.flushBuffer: Nothing to save.")}else{TS.log(488,"TS.storage.flushBuffer: Saved "+i+(i===1?" item":" items"))}},slow_get_threshold:1e3,slow_get:null,_get:function(name,default_value,log){var k=TS.storage.prefix+name;if(log)TS.info("_get name:"+name+" k:"+k+" disabled:"+TS.storage.disabled+" TS.storage.buffer[k]:"+TS.storage.buffer[k]);if(TS.storage.disabled){return TS.storage.buffer[k]||default_value}if(k in TS.storage.buffer){return TS.storage.buffer[k]||default_value}var elapsed=new Date;var result=TS.storage.correctBadValsFromStorage(_ls.getItem(k));if(log)TS.info("_get TS.storage.correctBadValsFromStorage(_ls.getItem(k)):"+result);var storage_size;if(result&&typeof result=="string"&&/^[{[]/.test(result)){try{result=JSON.parse(result)}catch(err){}}result=result||(default_value||null);elapsed=new Date-elapsed;if(!TS.storage.slow_get&&elapsed>TS.storage.slow_get_threshold){TS.storage.slow_get=true;try{storage_size=TS.storage.storageSize()}catch(err){}TS.logError({message:"Took "+elapsed+"ms to read "+k+" (theshold is "+TS.storage.slow_get_threshold+"ms), length = "+(result&&!isNaN(result.length)?result.length:"unknown")+". Storage size: "+storage_size},"TS.storage._get took longer than threshold")}return result},slow_set_threshold:1e3,slow_set:null,_set:function(name,value,immediate,log){var elapsed=new Date;var storage_size;var k=TS.storage.prefix+name;TS.storage.buffer[k]=value;var failed=false;if(log)TS.info("_set immediate:"+immediate+" name:"+name+" k:"+k+" disabled:"+TS.storage.disabled+" TS.storage.buffer[k]:"+TS.storage.buffer[k]);if(immediate){if(!TS.storage.disabled){var val=TS.storage.prepareValForStorage(value);if(val===undefined){_ls.removeItem(k)}else{try{_ls.setItem(k,val);var new_val=_ls.getItem(k);if(name=="testing_breakage")new_val+="BREAKAGE";if(new_val!==val){var err_desc="_ls.setItem() failed";var err_msg="k:"+k+", val:"+val+", new_val:"+new_val+", _using_macgap_ls:"+_using_macgap_ls;TS.logError({message:err_msg},err_desc);TS.warn(err_msg+"\n"+err_desc)}}catch(err){TS.warn("_set _ls.setItem failed, flushing. TS.storage.storageSize():"+TS.storage.storageSize(false));failed=true;_ls.clear()}}}if(log)TS.info("_set failed:"+failed);if(!failed){delete TS.storage.buffer[k];if(log)TS.info("_set TS.storage.buffer[k]:"+TS.storage.buffer[k]);elapsed=new Date-elapsed;if(elapsed>TS.storage.slow_set_threshold){TS.warn("TS.storage._set immediately "+name+": "+elapsed+"ms "+(value&&value.toString?value.toString().substr(0,100):"NULL?"));if(!TS.storage.slow_set){TS.storage.slow_set=true;try{storage_size=TS.storage.storageSize()}catch(err){}TS.logError({message:"Took "+elapsed+"ms to write "+k+" (theshold is "+TS.storage.slow_set_threshold+"ms), length = "+(value&&!isNaN(value.length)?value.length:"unknown")+". Storage length: "+storage_size},"TS.storage._set exceeded slow set threshold (immediate)")}}else{TS.log(488,"TS.storage._set immediately "+name+": "+elapsed+"ms "+(value&&value.toString?value.toString().substr(0,100):"NULL?"))}return}}if(!TS.storage.disabled){if(!TS.storage.flush_buffer_interv){TS.storage.flush_buffer_interv=setInterval(TS.storage.onFlushBufferInterval,TS.storage.flush_buffer_interv_ms)}}},fetchStorageVersion:function(){return TS.storage._get("storage_version")},storeStorageVersion:function(val){TS.storage._set("storage_version",val,true)},fetchMsgsStorageVersion:function(){return TS.storage._get("storage_msgs_version")},storeMsgsStorageVersion:function(val){TS.storage._set("storage_msgs_version",val,true)},msgs_id_part:"channel_msgs_",_makeMsgsId:function(id){return TS.storage.msgs_id_part+id},fetchMsgsRaw:function(id){return TS.storage._get(TS.storage._makeMsgsId(id),[])||[]},fetchMsgs:function(id){var msgs=JSON.parse(JSON.stringify(TS.storage._get(TS.storage._makeMsgsId(id),[])||[]));var A=[];var imsg;for(var i=0;i<msgs.length;i++){if(TS.qs_args["not_all_ls_msgs"]&&i<5)continue;imsg=msgs[i];if(!imsg.ts)continue;if(TS.utility.msgs.isTempMsg(imsg))continue;if(imsg.is_ephemeral)continue;A.push(TS.utility.msgs.processImsg(imsg,id))}return A},storeMsgs:function(id,msgs){TS.storage._set(TS.storage._makeMsgsId(id),msgs);if(msgs&&msgs.length){var last_msg_ts=TS.storage.fetchLastMsgTS();if(msgs[0].ts>last_msg_ts){TS.storage.storeLastMsgTS(msgs[0].ts)}}},_makeMsgInputId:function(id){return"msg_input_"+id},fetchLastMsgInput:function(id){return TS.storage._get(TS.storage._makeMsgInputId(id),null)},storeLastMsgInput:function(id,txt){TS.storage._set(TS.storage._makeMsgInputId(id),txt)},_makeCommentInputId:function(id){return"comment_input_"+id},fetchLastCommentInput:function(id){return TS.storage._get(TS.storage._makeCommentInputId(id),null)},storeLastCommentInput:function(id,txt){TS.storage._set(TS.storage._makeCommentInputId(id),txt)},oldest_ts_part:"oldest_msg_ts_",_makeOldestTsId:function(id){return TS.storage.oldest_ts_part+id},fetchOldestTs:function(id){return TS.storage._get(TS.storage._makeOldestTsId(id),null)},storeOldestTs:function(id,ts){TS.storage._set(TS.storage._makeOldestTsId(id),ts);return},fetchActiveHistory:function(){return TS.storage._get("active_history",[])||[]},storeActiveHistory:function(history){TS.storage._set("active_history",history,true)},fetchLastEventTS:function(log){return TS.storage._get("last_event_ts","",log)||""},storeLastEventTS:function(ts,immediate,log){TS.storage._set("last_event_ts",ts,immediate,log)},fetchLastMsgTS:function(){return TS.storage._get("last_msg_ts","")||""},storeLastMsgTS:function(ts,immediate){TS.storage._set("last_msg_ts",ts,immediate)},fetchUIState:function(){return TS.storage._get("ui_state",{})||{}},storeUIState:function(state){TS.storage._set("ui_state",state)},fetchInlineImgState:function(){return TS.storage._get("inline_img_state",{})||{}},storeInlineImgState:function(state){TS.storage._set("inline_img_state",state)},fetchInlineVideoState:function(){return TS.storage._get("inline_video_state",{})||{}},storeInlineVideoState:function(state){TS.storage._set("inline_video_state",state)},fetchInlineAttachmentState:function(){return TS.storage._get("inline_attachment_state",{})||{}},storeInlineAttachmentState:function(state){TS.storage._set("inline_attachment_state",state)},fetchExpandableState:function(){return TS.storage._get("expandable_state",{})||{}},storeExpandableState:function(state){TS.storage._set("expandable_state",state)},fetchClientWindows:function(){return TS.storage._get("client_windows",{})||{}},storeClientWindows:function(wins){TS.storage._set("client_windows",wins)},fetchInputHistory:function(){var A=TS.storage._get("input_history",[])||[];var max=300;if(A.length>max)A.length=max;return A},storeInputHistory:function(history){TS.storage._set("input_history",history)},fetchChannelPageState:function(){return TS.storage._get("channel_page_state",{})||{}},storeChannelPageState:function(state){TS.storage._set("channel_page_state",state)},fetchRxnRecords:function(){return TS.storage._get("rxn_records",[])||[]},storeRxnRecords:function(rxn_records,immediate){TS.storage._set("rxn_records",rxn_records,immediate)},fetchInvitesState:function(){return TS.storage._get("invites_state",[])||[]},storeInvitesState:function(state){TS.storage._set("invites_state",state)}});var _using_macgap_ls=!!(window.macgap&&macgap.ls);var _ls=_using_macgap_ls?macgap.ls:window.localStorage;var _getLs=function(){return _ls};var _setLs=function(ls){_ls=ls}})();
